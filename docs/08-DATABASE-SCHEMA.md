# 08 — Database Schema

**Module:** Vehicle  
**Version:** 1.0  
**Database:** PostgreSQL 15+  
**Last Updated:** December 2024

---

## Overview

This document contains the complete database schema for the Vehicle module, ready for implementation. It includes all tables, enums, constraints, indexes, and seed data.

---

## 1. Enums

Create these ENUM types first, before creating tables.

### 1.1 vehicle_type

```sql
CREATE TYPE vehicle_type AS ENUM (
    'CARRO',
    'MOTO'
);
```

| Value | Display (PT-BR) | Description |
|-------|-----------------|-------------|
| `CARRO` | Carro | Automobile |
| `MOTO` | Moto | Motorcycle |

---

### 1.2 vehicle_status

```sql
CREATE TYPE vehicle_status AS ENUM (
    'ACTIVE',
    'SOLD',
    'DELETED'
);
```

| Value | Display (PT-BR) | Description |
|-------|-----------------|-------------|
| `ACTIVE` | Ativo | Normal state, receives reminders |
| `SOLD` | Vendido | Sold, no reminders, history preserved |
| `DELETED` | Excluído | Soft deleted, invisible to user |

---

### 1.3 brazilian_state

```sql
CREATE TYPE brazilian_state AS ENUM (
    'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA',
    'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN',
    'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
);
```

| Value | Name |
|-------|------|
| `AC` | Acre |
| `AL` | Alagoas |
| `AP` | Amapá |
| `AM` | Amazonas |
| `BA` | Bahia |
| `CE` | Ceará |
| `DF` | Distrito Federal |
| `ES` | Espírito Santo |
| `GO` | Goiás |
| `MA` | Maranhão |
| `MT` | Mato Grosso |
| `MS` | Mato Grosso do Sul |
| `MG` | Minas Gerais |
| `PA` | Pará |
| `PB` | Paraíba |
| `PR` | Paraná |
| `PE` | Pernambuco |
| `PI` | Piauí |
| `RJ` | Rio de Janeiro |
| `RN` | Rio Grande do Norte |
| `RS` | Rio Grande do Sul |
| `RO` | Rondônia |
| `RR` | Roraima |
| `SC` | Santa Catarina |
| `SP` | São Paulo |
| `SE` | Sergipe |
| `TO` | Tocantins |

---

### 1.4 fuel_type

```sql
CREATE TYPE fuel_type AS ENUM (
    'GASOLINA',
    'ETANOL',
    'FLEX',
    'DIESEL',
    'ELETRICO',
    'HIBRIDO'
);
```

| Value | Display (PT-BR) |
|-------|-----------------|
| `GASOLINA` | Gasolina |
| `ETANOL` | Etanol |
| `FLEX` | Flex |
| `DIESEL` | Diesel |
| `ELETRICO` | Elétrico |
| `HIBRIDO` | Híbrido |

---

### 1.5 transmission_type

```sql
CREATE TYPE transmission_type AS ENUM (
    'MANUAL',
    'AUTOMATICO',
    'CVT',
    'AUTOMATIZADO'
);
```

| Value | Display (PT-BR) |
|-------|-----------------|
| `MANUAL` | Manual |
| `AUTOMATICO` | Automático |
| `CVT` | CVT |
| `AUTOMATIZADO` | Automatizado |

---

### 1.6 catalog_source

```sql
CREATE TYPE catalog_source AS ENUM (
    'AI',
    'MANUAL',
    'VERIFIED'
);
```

| Value | Description |
|-------|-------------|
| `AI` | Generated by AI (needs review) |
| `MANUAL` | Entered manually by user |
| `VERIFIED` | Verified by admin/system |

---

### 1.7 maintenance_type

```sql
CREATE TYPE maintenance_type AS ENUM (
    'OLEO',
    'FILTRO_OLEO',
    'FILTRO_AR',
    'FILTRO_COMBUSTIVEL',
    'FILTRO_AC',
    'CORREIA_DENTADA',
    'CORREIA_ALTERNADOR',
    'VELAS',
    'CABOS_VELA',
    'PASTILHA_FREIO',
    'DISCO_FREIO',
    'FLUIDO_FREIO',
    'FLUIDO_ARREFECIMENTO',
    'FLUIDO_DIRECAO',
    'OLEO_CAMBIO',
    'SUSPENSAO',
    'AMORTECEDOR',
    'BATERIA',
    'PNEUS',
    'ALINHAMENTO',
    'BALANCEAMENTO',
    'AR_CONDICIONADO',
    'EMBREAGEM',
    'CUSTOM'
);
```

| Value | Display (PT-BR) | Description |
|-------|-----------------|-------------|
| `OLEO` | Óleo do motor | Engine oil change |
| `FILTRO_OLEO` | Filtro de óleo | Oil filter |
| `FILTRO_AR` | Filtro de ar | Air filter |
| `FILTRO_COMBUSTIVEL` | Filtro de combustível | Fuel filter |
| `FILTRO_AC` | Filtro do ar-condicionado | A/C cabin filter |
| `CORREIA_DENTADA` | Correia dentada | Timing belt |
| `CORREIA_ALTERNADOR` | Correia do alternador | Alternator/serpentine belt |
| `VELAS` | Velas de ignição | Spark plugs |
| `CABOS_VELA` | Cabos de vela | Spark plug wires |
| `PASTILHA_FREIO` | Pastilhas de freio | Brake pads |
| `DISCO_FREIO` | Discos de freio | Brake discs/rotors |
| `FLUIDO_FREIO` | Fluido de freio | Brake fluid |
| `FLUIDO_ARREFECIMENTO` | Fluido de arrefecimento | Coolant |
| `FLUIDO_DIRECAO` | Fluido de direção | Power steering fluid |
| `OLEO_CAMBIO` | Óleo do câmbio | Transmission fluid |
| `SUSPENSAO` | Suspensão | Suspension components |
| `AMORTECEDOR` | Amortecedores | Shock absorbers |
| `BATERIA` | Bateria | Battery |
| `PNEUS` | Pneus | Tires |
| `ALINHAMENTO` | Alinhamento | Wheel alignment |
| `BALANCEAMENTO` | Balanceamento | Wheel balancing |
| `AR_CONDICIONADO` | Ar-condicionado | A/C service |
| `EMBREAGEM` | Embreagem | Clutch |
| `CUSTOM` | Personalizado | User-defined custom type |

**Note:** When `type = 'CUSTOM'`, use the `custom_type_name` field to store the user's custom name.

---

## 2. Tables

### 2.1 vehicle_brands

**Purpose:** Master list of vehicle manufacturers. Separate entries for car and motorcycle brands.

```sql
CREATE TABLE vehicle_brands (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(100) NOT NULL,
    type            vehicle_type NOT NULL,
    logo_url        VARCHAR(500),
    verified        BOOLEAN NOT NULL DEFAULT false,
    created_by      UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_vehicle_brands_name_type UNIQUE (name, type)
);

-- Indexes
CREATE INDEX idx_vehicle_brands_type ON vehicle_brands (type);
CREATE INDEX idx_vehicle_brands_name ON vehicle_brands (name);
CREATE INDEX idx_vehicle_brands_verified ON vehicle_brands (verified);
```

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | gen_random_uuid() | Primary key |
| `name` | VARCHAR(100) | NO | — | Brand name (e.g., "Honda") |
| `type` | vehicle_type | NO | — | CARRO or MOTO |
| `logo_url` | VARCHAR(500) | YES | NULL | URL to brand logo |
| `verified` | BOOLEAN | NO | false | Admin-verified brand |
| `created_by` | UUID | YES | NULL | FK to users (if user-submitted) |
| `created_at` | TIMESTAMP | NO | NOW() | Creation timestamp |
| `updated_at` | TIMESTAMP | NO | NOW() | Last update timestamp |

**Constraints:**
- `UNIQUE(name, type)` — Same brand name can exist for CARRO and MOTO separately

---

### 2.2 vehicle_models

**Purpose:** Vehicle models within each brand.

```sql
CREATE TABLE vehicle_models (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    brand_id        UUID NOT NULL REFERENCES vehicle_brands(id) ON DELETE RESTRICT,
    name            VARCHAR(100) NOT NULL,
    type            vehicle_type NOT NULL,
    verified        BOOLEAN NOT NULL DEFAULT false,
    created_by      UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_vehicle_models_brand_name UNIQUE (brand_id, name)
);

-- Indexes
CREATE INDEX idx_vehicle_models_brand_id ON vehicle_models (brand_id);
CREATE INDEX idx_vehicle_models_name ON vehicle_models (name);
CREATE INDEX idx_vehicle_models_type ON vehicle_models (type);
```

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | gen_random_uuid() | Primary key |
| `brand_id` | UUID | NO | — | FK to vehicle_brands |
| `name` | VARCHAR(100) | NO | — | Model name (e.g., "Civic") |
| `type` | vehicle_type | NO | — | CARRO or MOTO |
| `verified` | BOOLEAN | NO | false | Admin-verified model |
| `created_by` | UUID | YES | NULL | FK to users (if user-submitted) |
| `created_at` | TIMESTAMP | NO | NOW() | Creation timestamp |
| `updated_at` | TIMESTAMP | NO | NOW() | Last update timestamp |

**Constraints:**
- `UNIQUE(brand_id, name)` — Can't have two "Civic" under same Honda brand

---

### 2.3 vehicle_catalogs

**Purpose:** Specific vehicle variants (Brand + Model + Year + Version). Contains technical specs.

```sql
CREATE TABLE vehicle_catalogs (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    model_id        UUID NOT NULL REFERENCES vehicle_models(id) ON DELETE RESTRICT,
    year            INTEGER NOT NULL,
    version         VARCHAR(100),
    engine          VARCHAR(50),
    fuel            fuel_type,
    transmission    transmission_type,
    source          catalog_source NOT NULL DEFAULT 'MANUAL',
    created_by      UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_vehicle_catalogs_model_year_version UNIQUE (model_id, year, version),
    CONSTRAINT chk_vehicle_catalogs_year CHECK (year >= 1950 AND year <= EXTRACT(YEAR FROM CURRENT_DATE) + 1)
);

-- Indexes
CREATE INDEX idx_vehicle_catalogs_model_id ON vehicle_catalogs (model_id);
CREATE INDEX idx_vehicle_catalogs_year ON vehicle_catalogs (year);
CREATE INDEX idx_vehicle_catalogs_model_year ON vehicle_catalogs (model_id, year);
```

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | gen_random_uuid() | Primary key |
| `model_id` | UUID | NO | — | FK to vehicle_models |
| `year` | INTEGER | NO | — | Model year (1950 to current+1) |
| `version` | VARCHAR(100) | YES | NULL | Trim level (e.g., "1.5 Turbo", "LX") |
| `engine` | VARCHAR(50) | YES | NULL | Engine spec (e.g., "1.5L") |
| `fuel` | fuel_type | YES | NULL | Fuel type |
| `transmission` | transmission_type | YES | NULL | Transmission type |
| `source` | catalog_source | NO | 'MANUAL' | How entry was created |
| `created_by` | UUID | YES | NULL | Who created it |
| `created_at` | TIMESTAMP | NO | NOW() | Creation timestamp |
| `updated_at` | TIMESTAMP | NO | NOW() | Last update timestamp |

**Constraints:**
- `UNIQUE(model_id, year, version)` — Allows multiple versions per year (e.g., Civic 2020 LX, Civic 2020 EX)
- `CHECK year` — Year must be between 1950 and next year

**Note:** If `version` is NULL, uniqueness is on `(model_id, year)` only.

---

### 2.4 maintenance_templates

**Purpose:** Default maintenance intervals for each catalog entry. AI-generated or manually added.

```sql
CREATE TABLE maintenance_templates (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    catalog_id          UUID NOT NULL REFERENCES vehicle_catalogs(id) ON DELETE CASCADE,
    type                maintenance_type NOT NULL,
    custom_type_name    VARCHAR(100),
    interval_km         INTEGER,
    interval_months     INTEGER,
    description         VARCHAR(200) NOT NULL,
    notes               TEXT,
    created_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_maintenance_templates_catalog_type UNIQUE (catalog_id, type, custom_type_name),
    CONSTRAINT chk_maintenance_templates_interval CHECK (
        interval_km IS NOT NULL OR interval_months IS NOT NULL
    ),
    CONSTRAINT chk_maintenance_templates_interval_km CHECK (
        interval_km IS NULL OR interval_km > 0
    ),
    CONSTRAINT chk_maintenance_templates_interval_months CHECK (
        interval_months IS NULL OR (interval_months > 0 AND interval_months <= 120)
    ),
    CONSTRAINT chk_maintenance_templates_custom CHECK (
        (type = 'CUSTOM' AND custom_type_name IS NOT NULL) OR
        (type != 'CUSTOM' AND custom_type_name IS NULL)
    )
);

-- Indexes
CREATE INDEX idx_maintenance_templates_catalog_id ON maintenance_templates (catalog_id);
CREATE INDEX idx_maintenance_templates_type ON maintenance_templates (type);
```

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | gen_random_uuid() | Primary key |
| `catalog_id` | UUID | NO | — | FK to vehicle_catalogs |
| `type` | maintenance_type | NO | — | Type of maintenance |
| `custom_type_name` | VARCHAR(100) | YES | NULL | Name when type='CUSTOM' |
| `interval_km` | INTEGER | YES | NULL | KM interval (e.g., 10000) |
| `interval_months` | INTEGER | YES | NULL | Month interval (e.g., 12) |
| `description` | VARCHAR(200) | NO | — | Display description |
| `notes` | TEXT | YES | NULL | Additional notes |
| `created_at` | TIMESTAMP | NO | NOW() | Creation timestamp |
| `updated_at` | TIMESTAMP | NO | NOW() | Last update timestamp |

**Constraints:**
- At least one of `interval_km` or `interval_months` must be set
- `interval_km` must be positive if set
- `interval_months` must be 1-120 if set
- If `type = 'CUSTOM'`, `custom_type_name` is required
- If `type != 'CUSTOM'`, `custom_type_name` must be NULL

---

### 2.5 user_vehicles

**Purpose:** User's registered vehicles. This is the CORE table of the module.

```sql
CREATE TABLE user_vehicles (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    catalog_id      UUID REFERENCES vehicle_catalogs(id) ON DELETE SET NULL,
    placa           VARCHAR(7) NOT NULL,
    type            vehicle_type NOT NULL,
    status          vehicle_status NOT NULL DEFAULT 'ACTIVE',
    estado          brazilian_state NOT NULL,
    apelido         VARCHAR(50),
    cor             VARCHAR(30),
    renavam         VARCHAR(11),
    ano             INTEGER NOT NULL,
    km_atual        INTEGER,
    photo_url       VARCHAR(500),
    sold_at         TIMESTAMP WITH TIME ZONE,
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    deleted_at      TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT uq_user_vehicles_placa UNIQUE (placa),
    CONSTRAINT chk_user_vehicles_placa CHECK (
        placa ~ '^[A-Z]{3}[0-9][A-Z0-9][0-9]{2}$'
    ),
    CONSTRAINT chk_user_vehicles_ano CHECK (
        ano >= 1950 AND ano <= EXTRACT(YEAR FROM CURRENT_DATE) + 1
    ),
    CONSTRAINT chk_user_vehicles_km CHECK (
        km_atual IS NULL OR (km_atual >= 0 AND km_atual <= 9999999)
    ),
    CONSTRAINT chk_user_vehicles_renavam CHECK (
        renavam IS NULL OR renavam ~ '^[0-9]{9,11}$'
    )
);

-- Indexes
CREATE INDEX idx_user_vehicles_user_id ON user_vehicles (user_id);
CREATE INDEX idx_user_vehicles_status ON user_vehicles (status);
CREATE INDEX idx_user_vehicles_placa ON user_vehicles (placa);
CREATE INDEX idx_user_vehicles_deleted_at ON user_vehicles (deleted_at) WHERE deleted_at IS NOT NULL;
CREATE INDEX idx_user_vehicles_user_active ON user_vehicles (user_id) WHERE deleted_at IS NULL AND status = 'ACTIVE';
```

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | gen_random_uuid() | Primary key |
| `user_id` | UUID | NO | — | FK to users (owner) |
| `catalog_id` | UUID | YES | NULL | FK to vehicle_catalogs |
| `placa` | VARCHAR(7) | NO | — | License plate (GLOBALLY UNIQUE) |
| `type` | vehicle_type | NO | — | CARRO or MOTO |
| `status` | vehicle_status | NO | 'ACTIVE' | Current status |
| `estado` | brazilian_state | NO | — | Brazilian state (for IPVA) |
| `apelido` | VARCHAR(50) | YES | NULL | User nickname for vehicle |
| `cor` | VARCHAR(30) | YES | NULL | Vehicle color |
| `renavam` | VARCHAR(11) | YES | NULL | Renavam number (9-11 digits) |
| `ano` | INTEGER | NO | — | Vehicle year |
| `km_atual` | INTEGER | YES | NULL | Current odometer |
| `photo_url` | VARCHAR(500) | YES | NULL | S3 URL to vehicle photo |
| `sold_at` | TIMESTAMP | YES | NULL | When marked as sold |
| `created_at` | TIMESTAMP | NO | NOW() | Creation timestamp |
| `updated_at` | TIMESTAMP | NO | NOW() | Last update timestamp |
| `deleted_at` | TIMESTAMP | YES | NULL | Soft delete timestamp |

**Constraints:**
- `placa` is **GLOBALLY UNIQUE** (one vehicle per plate in entire system)
- `placa` format: ABC1234 (old) or ABC1D23 (Mercosul)
- `ano` between 1950 and next year
- `km_atual` between 0 and 9,999,999
- `renavam` is 9-11 digits if provided

---

### 2.6 user_maintenance_overrides

**Purpose:** User customizations to catalog maintenance intervals. User can set different intervals than catalog defaults.

```sql
CREATE TABLE user_maintenance_overrides (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_vehicle_id         UUID NOT NULL REFERENCES user_vehicles(id) ON DELETE CASCADE,
    maintenance_type        maintenance_type NOT NULL,
    custom_type_name        VARCHAR(100),
    custom_interval_km      INTEGER,
    custom_interval_months  INTEGER,
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_user_maintenance_overrides UNIQUE (user_vehicle_id, maintenance_type, custom_type_name),
    CONSTRAINT chk_user_maintenance_overrides_interval CHECK (
        custom_interval_km IS NOT NULL OR custom_interval_months IS NOT NULL
    ),
    CONSTRAINT chk_user_maintenance_overrides_km CHECK (
        custom_interval_km IS NULL OR custom_interval_km > 0
    ),
    CONSTRAINT chk_user_maintenance_overrides_months CHECK (
        custom_interval_months IS NULL OR (custom_interval_months > 0 AND custom_interval_months <= 120)
    )
);

-- Indexes
CREATE INDEX idx_user_maintenance_overrides_vehicle ON user_maintenance_overrides (user_vehicle_id);
```

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | gen_random_uuid() | Primary key |
| `user_vehicle_id` | UUID | NO | — | FK to user_vehicles |
| `maintenance_type` | maintenance_type | NO | — | Which maintenance item |
| `custom_type_name` | VARCHAR(100) | YES | NULL | Name when type='CUSTOM' |
| `custom_interval_km` | INTEGER | YES | NULL | Custom KM interval |
| `custom_interval_months` | INTEGER | YES | NULL | Custom month interval |
| `created_at` | TIMESTAMP | NO | NOW() | Creation timestamp |
| `updated_at` | TIMESTAMP | NO | NOW() | Last update timestamp |

**Constraints:**
- `UNIQUE(user_vehicle_id, maintenance_type, custom_type_name)` — One override per type per vehicle
- At least one interval must be set

---

### 2.7 maintenance_history

**Purpose:** Record of completed maintenance for each vehicle.

```sql
CREATE TABLE maintenance_history (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_vehicle_id     UUID NOT NULL REFERENCES user_vehicles(id) ON DELETE CASCADE,
    reminder_id         UUID REFERENCES reminders(id) ON DELETE SET NULL,
    maintenance_type    maintenance_type NOT NULL,
    custom_type_name    VARCHAR(100),
    completed_at        DATE NOT NULL,
    km_at_completion    INTEGER,
    cost                DECIMAL(10, 2),
    notes               TEXT,
    service_provider    VARCHAR(200),
    created_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT chk_maintenance_history_completed CHECK (
        completed_at <= CURRENT_DATE
    ),
    CONSTRAINT chk_maintenance_history_km CHECK (
        km_at_completion IS NULL OR (km_at_completion >= 0 AND km_at_completion <= 9999999)
    ),
    CONSTRAINT chk_maintenance_history_cost CHECK (
        cost IS NULL OR cost >= 0
    )
);

-- Indexes
CREATE INDEX idx_maintenance_history_vehicle ON maintenance_history (user_vehicle_id);
CREATE INDEX idx_maintenance_history_completed ON maintenance_history (completed_at);
CREATE INDEX idx_maintenance_history_type ON maintenance_history (maintenance_type);
CREATE INDEX idx_maintenance_history_reminder ON maintenance_history (reminder_id) WHERE reminder_id IS NOT NULL;
```

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `id` | UUID | NO | gen_random_uuid() | Primary key |
| `user_vehicle_id` | UUID | NO | — | FK to user_vehicles |
| `reminder_id` | UUID | YES | NULL | FK to reminders (if from reminder) |
| `maintenance_type` | maintenance_type | NO | — | Type of maintenance |
| `custom_type_name` | VARCHAR(100) | YES | NULL | Name when type='CUSTOM' |
| `completed_at` | DATE | NO | — | When maintenance was done |
| `km_at_completion` | INTEGER | YES | NULL | Odometer at completion |
| `cost` | DECIMAL(10,2) | YES | NULL | Cost in BRL |
| `notes` | TEXT | YES | NULL | User notes |
| `service_provider` | VARCHAR(200) | YES | NULL | Where service was done |
| `created_at` | TIMESTAMP | NO | NOW() | Record creation time |

**Constraints:**
- `completed_at` cannot be in the future
- `km_at_completion` between 0 and 9,999,999
- `cost` must be non-negative

---

## 3. Foreign Key Summary

| Table | Column | References | On Delete |
|-------|--------|------------|-----------|
| vehicle_brands | created_by | users.id | SET NULL |
| vehicle_models | brand_id | vehicle_brands.id | RESTRICT |
| vehicle_models | created_by | users.id | SET NULL |
| vehicle_catalogs | model_id | vehicle_models.id | RESTRICT |
| vehicle_catalogs | created_by | users.id | SET NULL |
| maintenance_templates | catalog_id | vehicle_catalogs.id | CASCADE |
| user_vehicles | user_id | users.id | CASCADE |
| user_vehicles | catalog_id | vehicle_catalogs.id | SET NULL |
| user_maintenance_overrides | user_vehicle_id | user_vehicles.id | CASCADE |
| maintenance_history | user_vehicle_id | user_vehicles.id | CASCADE |
| maintenance_history | reminder_id | reminders.id | SET NULL |

---

## 4. Triggers

### 4.1 Auto-update `updated_at`

```sql
-- Function
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply to all tables with updated_at
CREATE TRIGGER trg_vehicle_brands_updated_at
    BEFORE UPDATE ON vehicle_brands
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_vehicle_models_updated_at
    BEFORE UPDATE ON vehicle_models
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_vehicle_catalogs_updated_at
    BEFORE UPDATE ON vehicle_catalogs
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_maintenance_templates_updated_at
    BEFORE UPDATE ON maintenance_templates
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_user_vehicles_updated_at
    BEFORE UPDATE ON user_vehicles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_user_maintenance_overrides_updated_at
    BEFORE UPDATE ON user_maintenance_overrides
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## 5. Migration Order

Run migrations in this order:

```
1. Create enums (all 7 enums)
2. Create vehicle_brands table
3. Create vehicle_models table
4. Create vehicle_catalogs table
5. Create maintenance_templates table
6. Create user_vehicles table
7. Create user_maintenance_overrides table
8. Create maintenance_history table
9. Create triggers
10. Run seed data
```

---

## 6. Seed Data

### 6.1 Vehicle Brands (Carros)

```sql
INSERT INTO vehicle_brands (id, name, type, verified, created_at, updated_at) VALUES
    (gen_random_uuid(), 'Chevrolet', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Fiat', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Ford', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Honda', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Hyundai', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Jeep', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Kia', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Mitsubishi', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Nissan', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Peugeot', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Renault', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Toyota', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Volkswagen', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'BMW', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Mercedes-Benz', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Audi', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Citroën', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Caoa Chery', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'BYD', 'CARRO', true, NOW(), NOW()),
    (gen_random_uuid(), 'GWM', 'CARRO', true, NOW(), NOW());
```

### 6.2 Vehicle Brands (Motos)

```sql
INSERT INTO vehicle_brands (id, name, type, verified, created_at, updated_at) VALUES
    (gen_random_uuid(), 'Honda', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Yamaha', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Suzuki', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Kawasaki', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'BMW', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Harley-Davidson', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Triumph', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Ducati', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Royal Enfield', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Dafra', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Shineray', 'MOTO', true, NOW(), NOW()),
    (gen_random_uuid(), 'Haojue', 'MOTO', true, NOW(), NOW());
```

### 6.3 Popular Models (Honda Carro)

```sql
-- Get Honda CARRO brand ID first
DO $$
DECLARE
    honda_carro_id UUID;
BEGIN
    SELECT id INTO honda_carro_id FROM vehicle_brands WHERE name = 'Honda' AND type = 'CARRO';
    
    INSERT INTO vehicle_models (id, brand_id, name, type, verified, created_at, updated_at) VALUES
        (gen_random_uuid(), honda_carro_id, 'Civic', 'CARRO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_carro_id, 'City', 'CARRO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_carro_id, 'HR-V', 'CARRO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_carro_id, 'CR-V', 'CARRO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_carro_id, 'Fit', 'CARRO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_carro_id, 'WR-V', 'CARRO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_carro_id, 'Accord', 'CARRO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_carro_id, 'ZR-V', 'CARRO', true, NOW(), NOW());
END $$;
```

### 6.4 Popular Models (Honda Moto)

```sql
DO $$
DECLARE
    honda_moto_id UUID;
BEGIN
    SELECT id INTO honda_moto_id FROM vehicle_brands WHERE name = 'Honda' AND type = 'MOTO';
    
    INSERT INTO vehicle_models (id, brand_id, name, type, verified, created_at, updated_at) VALUES
        (gen_random_uuid(), honda_moto_id, 'CG 160', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'CG 125', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'Biz 125', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'Pop 110', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'CB 500F', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'CB 500X', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'CB 650R', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'XRE 300', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'XRE 190', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'NXR 160 Bros', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'PCX 160', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'Elite 125', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'ADV 350', 'MOTO', true, NOW(), NOW()),
        (gen_random_uuid(), honda_moto_id, 'Africa Twin', 'MOTO', true, NOW(), NOW());
END $$;
```

### 6.5 Popular Models (Other Brands)

```sql
-- Toyota
DO $$
DECLARE brand_id UUID;
BEGIN
    SELECT id INTO brand_id FROM vehicle_brands WHERE name = 'Toyota' AND type = 'CARRO';
    INSERT INTO vehicle_models (brand_id, name, type, verified) VALUES
        (brand_id, 'Corolla', 'CARRO', true),
        (brand_id, 'Corolla Cross', 'CARRO', true),
        (brand_id, 'Hilux', 'CARRO', true),
        (brand_id, 'SW4', 'CARRO', true),
        (brand_id, 'Yaris', 'CARRO', true),
        (brand_id, 'RAV4', 'CARRO', true),
        (brand_id, 'Camry', 'CARRO', true);
END $$;

-- Volkswagen
DO $$
DECLARE brand_id UUID;
BEGIN
    SELECT id INTO brand_id FROM vehicle_brands WHERE name = 'Volkswagen' AND type = 'CARRO';
    INSERT INTO vehicle_models (brand_id, name, type, verified) VALUES
        (brand_id, 'Gol', 'CARRO', true),
        (brand_id, 'Polo', 'CARRO', true),
        (brand_id, 'Virtus', 'CARRO', true),
        (brand_id, 'T-Cross', 'CARRO', true),
        (brand_id, 'Nivus', 'CARRO', true),
        (brand_id, 'Taos', 'CARRO', true),
        (brand_id, 'Tiguan', 'CARRO', true),
        (brand_id, 'Jetta', 'CARRO', true),
        (brand_id, 'Saveiro', 'CARRO', true),
        (brand_id, 'Amarok', 'CARRO', true);
END $$;

-- Fiat
DO $$
DECLARE brand_id UUID;
BEGIN
    SELECT id INTO brand_id FROM vehicle_brands WHERE name = 'Fiat' AND type = 'CARRO';
    INSERT INTO vehicle_models (brand_id, name, type, verified) VALUES
        (brand_id, 'Uno', 'CARRO', true),
        (brand_id, 'Mobi', 'CARRO', true),
        (brand_id, 'Argo', 'CARRO', true),
        (brand_id, 'Cronos', 'CARRO', true),
        (brand_id, 'Pulse', 'CARRO', true),
        (brand_id, 'Fastback', 'CARRO', true),
        (brand_id, 'Strada', 'CARRO', true),
        (brand_id, 'Toro', 'CARRO', true),
        (brand_id, 'Fiorino', 'CARRO', true);
END $$;

-- Chevrolet
DO $$
DECLARE brand_id UUID;
BEGIN
    SELECT id INTO brand_id FROM vehicle_brands WHERE name = 'Chevrolet' AND type = 'CARRO';
    INSERT INTO vehicle_models (brand_id, name, type, verified) VALUES
        (brand_id, 'Onix', 'CARRO', true),
        (brand_id, 'Onix Plus', 'CARRO', true),
        (brand_id, 'Tracker', 'CARRO', true),
        (brand_id, 'Spin', 'CARRO', true),
        (brand_id, 'S10', 'CARRO', true),
        (brand_id, 'Trailblazer', 'CARRO', true),
        (brand_id, 'Montana', 'CARRO', true),
        (brand_id, 'Equinox', 'CARRO', true),
        (brand_id, 'Cruze', 'CARRO', true);
END $$;

-- Hyundai
DO $$
DECLARE brand_id UUID;
BEGIN
    SELECT id INTO brand_id FROM vehicle_brands WHERE name = 'Hyundai' AND type = 'CARRO';
    INSERT INTO vehicle_models (brand_id, name, type, verified) VALUES
        (brand_id, 'HB20', 'CARRO', true),
        (brand_id, 'HB20S', 'CARRO', true),
        (brand_id, 'Creta', 'CARRO', true),
        (brand_id, 'Tucson', 'CARRO', true),
        (brand_id, 'Santa Fe', 'CARRO', true),
        (brand_id, 'i30', 'CARRO', true),
        (brand_id, 'Azera', 'CARRO', true);
END $$;

-- Yamaha Motos
DO $$
DECLARE brand_id UUID;
BEGIN
    SELECT id INTO brand_id FROM vehicle_brands WHERE name = 'Yamaha' AND type = 'MOTO';
    INSERT INTO vehicle_models (brand_id, name, type, verified) VALUES
        (brand_id, 'Factor 150', 'MOTO', true),
        (brand_id, 'Factor 125', 'MOTO', true),
        (brand_id, 'Fazer 250', 'MOTO', true),
        (brand_id, 'MT-03', 'MOTO', true),
        (brand_id, 'MT-07', 'MOTO', true),
        (brand_id, 'MT-09', 'MOTO', true),
        (brand_id, 'XTZ 150 Crosser', 'MOTO', true),
        (brand_id, 'XTZ 250 Lander', 'MOTO', true),
        (brand_id, 'XTZ 250 Ténéré', 'MOTO', true),
        (brand_id, 'YBR 150', 'MOTO', true),
        (brand_id, 'Neo 125', 'MOTO', true),
        (brand_id, 'NMAX 160', 'MOTO', true),
        (brand_id, 'R3', 'MOTO', true),
        (brand_id, 'R1', 'MOTO', true);
END $$;
```

---

## 7. Complete SQL Script

Here's the complete script to run in order:

```sql
-- =============================================
-- AUTOKEEPER - VEHICLE MODULE DATABASE SCHEMA
-- Version: 1.0
-- =============================================

-- 1. ENUMS
-- =============================================

CREATE TYPE vehicle_type AS ENUM ('CARRO', 'MOTO');

CREATE TYPE vehicle_status AS ENUM ('ACTIVE', 'SOLD', 'DELETED');

CREATE TYPE brazilian_state AS ENUM (
    'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA',
    'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN',
    'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
);

CREATE TYPE fuel_type AS ENUM (
    'GASOLINA', 'ETANOL', 'FLEX', 'DIESEL', 'ELETRICO', 'HIBRIDO'
);

CREATE TYPE transmission_type AS ENUM (
    'MANUAL', 'AUTOMATICO', 'CVT', 'AUTOMATIZADO'
);

CREATE TYPE catalog_source AS ENUM ('AI', 'MANUAL', 'VERIFIED');

CREATE TYPE maintenance_type AS ENUM (
    'OLEO', 'FILTRO_OLEO', 'FILTRO_AR', 'FILTRO_COMBUSTIVEL', 'FILTRO_AC',
    'CORREIA_DENTADA', 'CORREIA_ALTERNADOR', 'VELAS', 'CABOS_VELA',
    'PASTILHA_FREIO', 'DISCO_FREIO', 'FLUIDO_FREIO', 'FLUIDO_ARREFECIMENTO',
    'FLUIDO_DIRECAO', 'OLEO_CAMBIO', 'SUSPENSAO', 'AMORTECEDOR', 'BATERIA',
    'PNEUS', 'ALINHAMENTO', 'BALANCEAMENTO', 'AR_CONDICIONADO', 'EMBREAGEM',
    'CUSTOM'
);

-- 2. TABLES
-- =============================================

-- 2.1 vehicle_brands
CREATE TABLE vehicle_brands (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(100) NOT NULL,
    type            vehicle_type NOT NULL,
    logo_url        VARCHAR(500),
    verified        BOOLEAN NOT NULL DEFAULT false,
    created_by      UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_vehicle_brands_name_type UNIQUE (name, type)
);

CREATE INDEX idx_vehicle_brands_type ON vehicle_brands (type);
CREATE INDEX idx_vehicle_brands_name ON vehicle_brands (name);
CREATE INDEX idx_vehicle_brands_verified ON vehicle_brands (verified);

-- 2.2 vehicle_models
CREATE TABLE vehicle_models (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    brand_id        UUID NOT NULL REFERENCES vehicle_brands(id) ON DELETE RESTRICT,
    name            VARCHAR(100) NOT NULL,
    type            vehicle_type NOT NULL,
    verified        BOOLEAN NOT NULL DEFAULT false,
    created_by      UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_vehicle_models_brand_name UNIQUE (brand_id, name)
);

CREATE INDEX idx_vehicle_models_brand_id ON vehicle_models (brand_id);
CREATE INDEX idx_vehicle_models_name ON vehicle_models (name);
CREATE INDEX idx_vehicle_models_type ON vehicle_models (type);

-- 2.3 vehicle_catalogs
CREATE TABLE vehicle_catalogs (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    model_id        UUID NOT NULL REFERENCES vehicle_models(id) ON DELETE RESTRICT,
    year            INTEGER NOT NULL,
    version         VARCHAR(100),
    engine          VARCHAR(50),
    fuel            fuel_type,
    transmission    transmission_type,
    source          catalog_source NOT NULL DEFAULT 'MANUAL',
    created_by      UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_vehicle_catalogs_model_year_version UNIQUE (model_id, year, version),
    CONSTRAINT chk_vehicle_catalogs_year CHECK (year >= 1950 AND year <= EXTRACT(YEAR FROM CURRENT_DATE) + 1)
);

CREATE INDEX idx_vehicle_catalogs_model_id ON vehicle_catalogs (model_id);
CREATE INDEX idx_vehicle_catalogs_year ON vehicle_catalogs (year);
CREATE INDEX idx_vehicle_catalogs_model_year ON vehicle_catalogs (model_id, year);

-- 2.4 maintenance_templates
CREATE TABLE maintenance_templates (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    catalog_id          UUID NOT NULL REFERENCES vehicle_catalogs(id) ON DELETE CASCADE,
    type                maintenance_type NOT NULL,
    custom_type_name    VARCHAR(100),
    interval_km         INTEGER,
    interval_months     INTEGER,
    description         VARCHAR(200) NOT NULL,
    notes               TEXT,
    created_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_maintenance_templates_catalog_type UNIQUE (catalog_id, type, custom_type_name),
    CONSTRAINT chk_maintenance_templates_interval CHECK (interval_km IS NOT NULL OR interval_months IS NOT NULL),
    CONSTRAINT chk_maintenance_templates_interval_km CHECK (interval_km IS NULL OR interval_km > 0),
    CONSTRAINT chk_maintenance_templates_interval_months CHECK (interval_months IS NULL OR (interval_months > 0 AND interval_months <= 120)),
    CONSTRAINT chk_maintenance_templates_custom CHECK (
        (type = 'CUSTOM' AND custom_type_name IS NOT NULL) OR
        (type != 'CUSTOM' AND custom_type_name IS NULL)
    )
);

CREATE INDEX idx_maintenance_templates_catalog_id ON maintenance_templates (catalog_id);
CREATE INDEX idx_maintenance_templates_type ON maintenance_templates (type);

-- 2.5 user_vehicles
CREATE TABLE user_vehicles (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    catalog_id      UUID REFERENCES vehicle_catalogs(id) ON DELETE SET NULL,
    placa           VARCHAR(7) NOT NULL,
    type            vehicle_type NOT NULL,
    status          vehicle_status NOT NULL DEFAULT 'ACTIVE',
    estado          brazilian_state NOT NULL,
    apelido         VARCHAR(50),
    cor             VARCHAR(30),
    renavam         VARCHAR(11),
    ano             INTEGER NOT NULL,
    km_atual        INTEGER,
    photo_url       VARCHAR(500),
    sold_at         TIMESTAMP WITH TIME ZONE,
    created_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    deleted_at      TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT uq_user_vehicles_placa UNIQUE (placa),
    CONSTRAINT chk_user_vehicles_placa CHECK (placa ~ '^[A-Z]{3}[0-9][A-Z0-9][0-9]{2}$'),
    CONSTRAINT chk_user_vehicles_ano CHECK (ano >= 1950 AND ano <= EXTRACT(YEAR FROM CURRENT_DATE) + 1),
    CONSTRAINT chk_user_vehicles_km CHECK (km_atual IS NULL OR (km_atual >= 0 AND km_atual <= 9999999)),
    CONSTRAINT chk_user_vehicles_renavam CHECK (renavam IS NULL OR renavam ~ '^[0-9]{9,11}$')
);

CREATE INDEX idx_user_vehicles_user_id ON user_vehicles (user_id);
CREATE INDEX idx_user_vehicles_status ON user_vehicles (status);
CREATE INDEX idx_user_vehicles_placa ON user_vehicles (placa);
CREATE INDEX idx_user_vehicles_deleted_at ON user_vehicles (deleted_at) WHERE deleted_at IS NOT NULL;
CREATE INDEX idx_user_vehicles_user_active ON user_vehicles (user_id) WHERE deleted_at IS NULL AND status = 'ACTIVE';

-- 2.6 user_maintenance_overrides
CREATE TABLE user_maintenance_overrides (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_vehicle_id         UUID NOT NULL REFERENCES user_vehicles(id) ON DELETE CASCADE,
    maintenance_type        maintenance_type NOT NULL,
    custom_type_name        VARCHAR(100),
    custom_interval_km      INTEGER,
    custom_interval_months  INTEGER,
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT uq_user_maintenance_overrides UNIQUE (user_vehicle_id, maintenance_type, custom_type_name),
    CONSTRAINT chk_user_maintenance_overrides_interval CHECK (custom_interval_km IS NOT NULL OR custom_interval_months IS NOT NULL),
    CONSTRAINT chk_user_maintenance_overrides_km CHECK (custom_interval_km IS NULL OR custom_interval_km > 0),
    CONSTRAINT chk_user_maintenance_overrides_months CHECK (custom_interval_months IS NULL OR (custom_interval_months > 0 AND custom_interval_months <= 120))
);

CREATE INDEX idx_user_maintenance_overrides_vehicle ON user_maintenance_overrides (user_vehicle_id);

-- 2.7 maintenance_history
CREATE TABLE maintenance_history (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_vehicle_id     UUID NOT NULL REFERENCES user_vehicles(id) ON DELETE CASCADE,
    reminder_id         UUID REFERENCES reminders(id) ON DELETE SET NULL,
    maintenance_type    maintenance_type NOT NULL,
    custom_type_name    VARCHAR(100),
    completed_at        DATE NOT NULL,
    km_at_completion    INTEGER,
    cost                DECIMAL(10, 2),
    notes               TEXT,
    service_provider    VARCHAR(200),
    created_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    CONSTRAINT chk_maintenance_history_completed CHECK (completed_at <= CURRENT_DATE),
    CONSTRAINT chk_maintenance_history_km CHECK (km_at_completion IS NULL OR (km_at_completion >= 0 AND km_at_completion <= 9999999)),
    CONSTRAINT chk_maintenance_history_cost CHECK (cost IS NULL OR cost >= 0)
);

CREATE INDEX idx_maintenance_history_vehicle ON maintenance_history (user_vehicle_id);
CREATE INDEX idx_maintenance_history_completed ON maintenance_history (completed_at);
CREATE INDEX idx_maintenance_history_type ON maintenance_history (maintenance_type);
CREATE INDEX idx_maintenance_history_reminder ON maintenance_history (reminder_id) WHERE reminder_id IS NOT NULL;

-- 3. TRIGGERS
-- =============================================

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_vehicle_brands_updated_at
    BEFORE UPDATE ON vehicle_brands
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_vehicle_models_updated_at
    BEFORE UPDATE ON vehicle_models
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_vehicle_catalogs_updated_at
    BEFORE UPDATE ON vehicle_catalogs
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_maintenance_templates_updated_at
    BEFORE UPDATE ON maintenance_templates
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_user_vehicles_updated_at
    BEFORE UPDATE ON user_vehicles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_user_maintenance_overrides_updated_at
    BEFORE UPDATE ON user_maintenance_overrides
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =============================================
-- END OF SCHEMA
-- =============================================
```

---

## 8. Quick Reference

### Tables Summary

| Table | Purpose | Rows (expected) |
|-------|---------|-----------------|
| vehicle_brands | Master brand list | ~50 |
| vehicle_models | Models per brand | ~500 |
| vehicle_catalogs | Year-specific variants | ~5,000+ |
| maintenance_templates | Default intervals | ~50,000+ |
| user_vehicles | User's vehicles | Grows with users |
| user_maintenance_overrides | User customizations | Low volume |
| maintenance_history | Completed maintenance | Grows over time |

### Key Constraints

| Constraint | Table | Description |
|------------|-------|-------------|
| Global placa uniqueness | user_vehicles | One vehicle per plate in system |
| Brand + Type unique | vehicle_brands | Same brand for car and moto separately |
| Model + Year + Version unique | vehicle_catalogs | Prevents duplicate catalogs |
| At least one interval | maintenance_templates | km or months required |

---

**End of Database Schema Document**
